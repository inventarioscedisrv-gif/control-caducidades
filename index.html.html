<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Caducidades</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f5f7fb;
            --accent: #0f3b4a;
            --light-accent: #184a5f;
            --danger: #c33;
            --success: #0a6;
            --warning: #e65100;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: var(--accent);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        header h1 {
            margin: 0;
            font-size: 22px;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 15px;
            border-radius: 6px;
            border: 0;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: var(--light-accent);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #a22;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #084;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #c44100;
        }
        
        .search-filter {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-filter input, .search-filter select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            min-width: 200px;
            font-size: 14px;
        }
        
        .card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .card h3 {
            margin-top: 0;
            color: var(--accent);
            border-bottom: 2px solid var(--light-accent);
            padding-bottom: 10px;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .family-tag {
            background: #e6f7ff;
            color: #0070c0;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .status-expired {
            background: #ffebee;
            color: var(--danger);
        }
        
        .status-warning {
            background: #fff8e1;
            color: var(--warning);
        }
        
        .status-ok {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        th, td {
            border: 1px solid #e6eef2;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f3f6f8;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f7fb;
        }
        
        .editor {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
            color: var(--accent);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(15, 59, 74, 0.1);
        }
        
        .inline-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .inline-form .form-group {
            flex: 1;
            margin-bottom: 0;
            min-width: 150px;
        }
        
        .codes-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .code-pill {
            background: #eef;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .code-pill span {
            cursor: pointer;
            font-weight: bold;
            color: #555;
        }
        
        .code-pill span:hover {
            color: var(--danger);
        }
        
        .hidden {
            display: none;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card h3 {
            margin-top: 0;
            color: var(--accent);
            font-size: 16px;
        }
        
        .dashboard-card .value {
            font-size: 28px;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        
        .editor-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .ranges-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .range-item {
            background: #f3f6f8;
            padding: 12px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .range-item input {
            margin: 0;
        }
        
        .lot-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 2fr auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .lot-row input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .codes-display {
            font-size: 13px; 
            color: #666; 
            margin-top: 6px;
            background: #f8f8f8;
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .file-upload-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .file-format-info {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .file-format-info ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .file-format-info li {
            margin-bottom: 8px;
        }
        
        .file-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .file-input-wrapper input[type="file"] {
            flex: 1;
            padding: 12px;
            border: 2px dashed #ccc;
            border-radius: 6px;
            min-width: 300px;
        }
        
        .import-summary {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            background: #e8f5e9;
        }
        
        .import-summary.error {
            background: #ffebee;
        }
        
        .auto-save-info {
            background: #e3f2fd;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .auto-save-info .icon {
            font-size: 24px;
            color: #1565c0;
        }
        
        .save-notification {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            color: var(--accent);
            border-bottom: 2px solid var(--light-accent);
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        /* Nuevos estilos para el modal de guardado */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        
        .format-selector {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
        
        .format-selector label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .format-selector input[type="radio"] {
            margin-right: 10px;
        }
        
        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-controls .btn {
                margin-bottom: 8px;
            }
            
            .search-filter {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .product-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .inline-form {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .inline-form .form-group {
                width: 100%;
            }
            
            .lot-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Control de Caducidades</h1>
        <div class="header-controls">
            <button class="btn" onclick="showSection('dashboard')">Inicio</button>
            <button class="btn" onclick="showSection('productos')">Productos</button>
            <button class="btn" onclick="showSection('reportes')">Reportes</button>
            <button class="btn" onclick="showSection('importar')">Importar</button>
            <button class="btn" onclick="showSection('configuracion')">Configuraci贸n</button>
            <button class="btn btn-success" onclick="showSaveOptions()">Guardar en Excel</button>
        </div>
    </header>

    <div class="container">
        <!-- Dashboard Section -->
        <section id="dashboard">
            <h2 class="section-title">Inicio</h2>
            <div class="auto-save-info">
                <div class="icon"></div>
                <div>
                    <strong>Sistema de guardado 煤nico</strong><br>
                    Use el bot贸n "Guardar en Excel" para guardar todos los datos en un 煤nico archivo Excel.
                    Guarde este archivo en una carpeta espec铆fica para mantener sus datos seguros.
                </div>
            </div>
            <div class="dashboard-cards" id="dashboardCards"></div>
        </section>

        <!-- Productos Section -->
        <section id="productos" class="hidden">
            <h2 class="section-title">Gesti贸n de Productos</h2>
            <div class="controls">
                <button class="btn btn-success" onclick="nuevoProducto()">+ Nuevo Producto</button>
            </div>
            
            <!-- Editor de Productos en la parte superior -->
            <div id="editorPanel" class="editor hidden">
                <div class="editor-header">
                    <h3>Editar / Crear producto</h3>
                    <div class="editor-actions">
                        <button class="btn btn-success" onclick="saveProduct()">Guardar</button>
                        <button class="btn btn-danger" onclick="deleteProduct()" id="deleteBtn">Eliminar</button>
                        <button class="btn" onclick="closeEditor()">Cerrar</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>C贸digos de referencia</label>
                    <div class="codes-list" id="codesList"></div>
                    <div class="inline-form">
                        <div class="form-group">
                            <input id="newCodeInput" placeholder="Agregar c贸digo...">
                        </div>
                        <button class="btn" onclick="addCode()">Agregar</button>
                    </div>
                </div>
                
                <div class="inline-form">
                    <div class="form-group">
                        <label>Familia</label>
                        <select id="familySelect"></select>
                    </div>
                    <div class="form-group">
                        <label>Nueva familia</label>
                        <input id="newFamilyInput" placeholder="Agregar familia...">
                    </div>
                    <button class="btn" onclick="addFamily()">Agregar</button>
                </div>
                
                <div class="form-group">
                    <label>Descripci贸n</label>
                    <input id="editDesc" type="text">
                </div>
                
                <h4>Lotes (puedes agregar y editar varios)</h4>
                <div id="lotsContainer"></div>
                
                <div class="inline-form">
                    <div class="form-group">
                        <label>Cajas</label>
                        <input id="lot_cajas" type="number" placeholder="Cajas">
                    </div>
                    <div class="form-group">
                        <label>Piezas</label>
                        <input id="lot_piezas" type="number" placeholder="Piezas">
                    </div>
                    <div class="form-group">
                        <label>Fecha caducidad</label>
                        <input id="lot_fecha" type="date">
                    </div>
                    <div class="form-group">
                        <label>Fecha contado</label>
                        <input id="lot_contado" type="date">
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <input id="lot_notas" type="text" placeholder="Notas internas">
                    </div>
                    <button class="btn" onclick="addLot()">Agregar lote</button>
                </div>
            </div>
            
            <div class="search-filter">
                <div>
                    <label for="familyFilter">Filtrar por familia:</label>
                    <select id="familyFilter" onchange="renderInventory()">
                        <option value="">Todas las familias</option>
                    </select>
                </div>
                <div>
                    <label for="globalSearch">Buscar:</label>
                    <input id="globalSearch" type="text" placeholder="C贸digo or descripci贸n..." oninput="renderInventory()">
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button class="btn" onclick="clearFamilyFilter()">Quitar filtro</button>
                </div>
            </div>
            
            <div id="inventoryList"></div>
            <div class="small">Total de productos: <span id="totalCount">0</span></div>
        </section>

        <!-- Reportes Section -->
        <section id="reportes" class="hidden">
            <h2 class="section-title">Reportes de Caducidades</h2>
            
            <div class="card">
                <h3>Filtrar por rango de fechas</h3>
                <div class="ranges-container" id="rangesContainer"></div>
                <div class="controls">
                    <button class="btn" onclick="selectAllRanges()">Seleccionar todo</button>
                    <button class="btn" onclick="clearRanges()">Limpiar</button>
                    <button class="btn" onclick="exportReportToExcel()">Exportar Reporte</button>
                </div>
            </div>
            
            <div id="reportResult" style="margin-top: 20px;"></div>
        </section>

        <!-- Importar Section -->
        <section id="importar" class="hidden">
            <h2 class="section-title">Importar Productos desde Excel</h2>
            
            <div class="file-upload-container">
                <h3>Cargar archivo Excel</h3>
                
                <div class="format-selector">
                    <label>
                        <input type="radio" name="importFormat" value="basic" checked onchange="updateImportInstructions()">
                        Formato b谩sico (C贸digo, Descripci贸n, Familia)
                    </label>
                    <label>
                        <input type="radio" name="importFormat" value="full" onchange="updateImportInstructions()">
                        Formato completo (C贸digo, Descripci贸n, Familia, Cajas, Piezas, Fecha Caducidad, Fecha Contado, Notas)
                    </label>
                </div>
                
                <div class="file-format-info" id="formatInfo">
                    <p><strong>Formato requerido para el archivo Excel:</strong></p>
                    <ul>
                        <li>El archivo debe tener las columnas: <strong>C贸digo</strong>, <strong>Descripci贸n</strong> y <strong>Familia</strong></li>
                        <li>La primera fila debe contener los encabezados de columna</li>
                        <li>Los c贸digos deben estar en la primera columna (A)</li>
                        <li>Las descripciones en la segunda columna (B)</li>
                        <li>Las familias en la tercera columna (C)</li>
                    </ul>
                    <p>Los productos importados se agregar谩n a los existentes, sin eliminarlos.</p>
                </div>
                
                <div class="file-input-wrapper">
                    <input type="file" id="excelFileInput" accept=".xlsx, .xls">
                    <button class="btn btn-success" onclick="importExcel()">Importar</button>
                </div>
                
                <div id="importResult"></div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="showSection('productos')">Volver a Productos</button>
                <button class="btn btn-warning" onclick="clearAllProducts()">Eliminar Todos los Productos</button>
                <button class="btn btn-success" onclick="showSaveOptions()">Guardar en Excel</button>
            </div>
        </section>

        <!-- Configuraci贸n Section -->
        <section id="configuracion" class="hidden">
            <h2 class="section-title">Configuraci贸n</h2>

            <div class="card">
                <h3>Uso de almacenamiento</h3>
                <p>Revise cu谩nta informaci贸n est谩 almacenada en el sistema.</p>
                <button class="btn btn-success" onclick="checkStorageUsage()">Ver uso de almacenamiento</button>
                <div id="storageUsageResult" style="margin-top: 15px; font-weight: bold; color: var(--accent);"></div>
            </div>

            <div class="card">
                <h3>Datos</h3>
                <p><strong>Creado por:</strong> Alexis Aldo Ilizaliturri Alarid</p>
                <p><strong>Departamento:</strong> ALFA INVENTARIOS</p>
                <p><strong>Empresa:</strong> SUPER RIVERA</p>
                <img src="logo-super-rivera1.jpg" alt="Logo Super Rivera" style="max-width: 300px; margin-top: 15px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; background: white;">
            </div>
        </section>

    </div>

    <div class="save-notification" id="saveNotification">
        Datos guardados exitosamente en Control_Caducidades.xlsx
    </div>

    <!-- Modal para opciones de guardado -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <h3>Guardar en Excel</h3>
            <p>驴C贸mo desea guardar el archivo?</p>
            <div class="modal-buttons">
                <button class="btn" onclick="saveToExcel('new')">Guardar como nuevo</button>
                <button class="btn btn-success" onclick="saveToExcel('overwrite')">Sobrescribir existente</button>
                <button class="btn btn-danger" onclick="closeSaveModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Base de datos de productos
        let products = [
            {
                "codes": ["7509546686776"],
                "descripcion": "CAPRICE 200ML SH CONT/CASPA",
                "familia": "A1 SHAMPOO",
                "lotes": []
            },
            {
                "codes": ["7509546073033"],
                "descripcion": "CAPRICE 200ML SH ESP ACTI-CERAM",
                "familia": "A1 SHAMPOO",
                "lotes": []
            },
            {
                "codes": ["7509546073040"],
                "descripcion": "CAPRICE 200ML SH ESP BIOTINA",
                "familia": "A1 SHAMPOO",
                "lotes": []
            }
        ];

        let currentProductIndex = -1;
        let editingCodes = [];
        let editingLots = [];

        // Inicializaci贸n
        window.onload = function() {
            // Cargar datos guardados o usar los predeterminados
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                try {
                    products = JSON.parse(savedProducts);
                } catch (e) {
                    console.error("Error al cargar datos guardados:", e);
                    // Mantener los datos predeterminados si hay error
                    products = [
                        {
                            "codes": ["7509546686776"],
                            "descripcion": "CAPRICE 200ML SH CONT/CASPA",
                            "familia": "A1 SHAMPOO",
                            "lotes": []
                        },
                        {
                            "codes": ["7509546073033"],
                            "descripcion": "CAPRICE 200ML SH ESP ACTI-CERAM",
                            "familia": "A1 SHAMPOO",
                            "lotes": []
                        },
                        {
                            "codes": ["7509546073040"],
                            "descripcion": "CAPRICE 200ML SH ESP BIOTINA",
                            "familia": "A1 SHAMPOO",
                            "lotes": []
                        }
                    ];
                }
            }
            
            renderDashboard();
            populateFamilyFilter();
            populateFamilySelect();
            renderInventory();
            renderReports();
            showSection('dashboard');
        };

        // Funci贸n para actualizar las instrucciones de importaci贸n seg煤n el formato seleccionado
        function updateImportInstructions() {
            const formatInfo = document.getElementById('formatInfo');
            const format = document.querySelector('input[name="importFormat"]:checked').value;
            
            if (format === 'basic') {
                formatInfo.innerHTML = `
                    <p><strong>Formato requerido para el archivo Excel:</strong></p>
                    <ul>
                        <li>El archivo debe tener las columnas: <strong>C贸digo</strong>, <strong>Descripci贸n</strong> y <strong>Familia</strong></li>
                        <li>La primera fila debe contener los encabezados de columna</li>
                        <li>Los c贸digos deben estar en la primera columna (A)</li>
                        <li>Las descripciones en la segunda columna (B)</li>
                        <li>Las familias en la tercera columna (C)</li>
                    </ul>
                    <p>Los productos importados se agregar谩n a los existentes, sin eliminarlos.</p>
                `;
            } else {
                formatInfo.innerHTML = `
                    <p><strong>Formato requerido para el archivo Excel:</strong></p>
                    <ul>
                        <li>El archivo debe tener las columnas: <strong>C贸digo</strong>, <strong>Descripci贸n</strong>, <strong>Familia</strong>, <strong>Cajas</strong>, <strong>Piezas</strong>, <strong>Fecha Caducidad</strong>, <strong>Fecha Contado</strong>, <strong>Notas</strong></li>
                        <li>La primera fila debe contener los encabezados de columna</li>
                        <li>Los c贸digos deben estar en la primera columna (A)</li>
                        <li>Las descripciones en la segunda columna (B)</li>
                        <li>Las familias en la tercera columna (C)</li>
                        <li>Cajas en la cuarta columna (D)</li>
                        <li>Piezas en la quinta columna (E)</li>
                        <li>Fecha Caducidad en la sexta columna (F)</li>
                        <li>Fecha Contado en la s茅ptima columna (G)</li>
                        <li>Notas en la octava columna (H)</li>
                    </ul>
                    <p>Los productos importados se agregar谩n a los existentes, sin eliminarlos.</p>
                `;
            }
        }

        // Navegaci贸n entre secciones
        function showSection(sectionId) {
            // Ocultar todas las secciones
            const sections = document.querySelectorAll('section');
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            
            // Mostrar la secci贸n seleccionada
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Actualizar la secci贸n si es necesario
            if (sectionId === 'dashboard') {
                renderDashboard();
            } else if (sectionId === 'productos') {
                renderInventory();
            } else if (sectionId === 'reportes') {
                renderReports();
            }
        }

        // Dashboard
        function renderDashboard() {
            const cardsContainer = document.getElementById('dashboardCards');
            cardsContainer.innerHTML = '';
            
            // Calcular productos pr贸ximos a caducar en diferentes rangos
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Definir diferentes rangos de fechas
            const tenDays = new Date(today);
            tenDays.setDate(today.getDate() + 10);
            
            const oneMonth = new Date(today);
            oneMonth.setMonth(today.getMonth() + 1);
            
            const twoMonths = new Date(today);
            twoMonths.setMonth(today.getMonth() + 2);
            
            const threeMonths = new Date(today);
            threeMonths.setMonth(today.getMonth() + 3);
            
            let expiringInTenDaysCount = 0;
            let expiringInOneMonthCount = 0;
            let expiringInTwoMonthsCount = 0;
            let expiringInThreeMonthsCount = 0;
            let expiredCount = 0;
            let totalLotes = 0;
            
            products.forEach(product => {
                if (product.lotes && product.lotes.length > 0) {
                    totalLotes += product.lotes.length;
                    product.lotes.forEach(lote => {
                        if (lote.fecha) {
                            const expirationDate = new Date(lote.fecha);
                            expirationDate.setHours(0, 0, 0, 0);
                            
                            if (expirationDate < today) {
                                expiredCount++;
                            } else if (expirationDate <= tenDays) {
                                expiringInTenDaysCount++;
                            } else if (expirationDate <= oneMonth) {
                                expiringInOneMonthCount++;
                            } else if (expirationDate <= twoMonths) {
                                expiringInTwoMonthsCount++;
                            } else if (expirationDate <= threeMonths) {
                                expiringInThreeMonthsCount++;
                            }
                        }
                    });
                }
            });
            
            const cards = [
                { title: 'Total de productos', value: products.length, color: '#0f3b4a' },
                { title: 'Total de familias', value: [...new Set(products.map(p => p.familia))].length, color: '#1a5d7a' },
                { title: 'Pr贸ximos 1-10 d铆as', value: expiringInTenDaysCount, color: '#e65100' },
                { title: 'Pr贸ximos 1 mes', value: expiringInOneMonthCount, color: '#ff9800' },
                { title: 'Pr贸ximos 2 meses', value: expiringInTwoMonthsCount, color: '#ffa726' },
                { title: 'Pr贸ximos 3 meses', value: expiringInThreeMonthsCount, color: '#ffb74d' },
                { title: 'Caducados', value: expiredCount, color: '#c33' },
                { title: 'Total de lotes', value: totalLotes, color: '#2e7d32' }
            ];
            
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'dashboard-card';
                cardEl.innerHTML = `
                    <h3>${card.title}</h3>
                    <div class="value" style="color: ${card.color}">${card.value}</div>
                `;
                cardsContainer.appendChild(cardEl);
            });
        }

        // Inventario - Filtrado
        function populateFamilyFilter() {
            const familyFilter = document.getElementById('familyFilter');
            const families = [...new Set(products.map(p => p.familia))].sort();
            
            familyFilter.innerHTML = '<option value="">Todas las familias</option>';
            families.forEach(family => {
                const option = document.createElement('option');
                option.value = family;
                option.textContent = family;
                familyFilter.appendChild(option);
            });
        }

        function clearFamilyFilter() {
            document.getElementById('familyFilter').value = '';
            document.getElementById('globalSearch').value = '';
            renderInventory();
        }

        // Funci贸n para calcular meses y d铆as entre dos fechas
        function calculateMonthsAndDays(startDate, endDate) {
            // Asegurarse de que las fechas sean objetos Date v谩lidos
            if (!(startDate instanceof Date) || !(endDate instanceof Date)) {
                return { meses: 0, dias: 0 };
            }
            
            // Si la fecha ya pas贸, devolver valores negativos
            if (startDate > endDate) {
                const diffTime = startDate - endDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return { meses: 0, dias: -diffDays };
            }
            
            let meses = 0;
            let dias = 0;
            
            // Calcular meses
            let tempDate = new Date(startDate);
            while (tempDate < endDate) {
                tempDate.setMonth(tempDate.getMonth() + 1);
                if (tempDate <= endDate) {
                    meses++;
                } else {
                    tempDate.setMonth(tempDate.getMonth() - 1);
                    break;
                }
            }
            
            // Calcular d铆as restantes
            if (tempDate < endDate) {
                const diffTime = endDate - tempDate;
                dias = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            }
            
            return { meses, dias };
        }

        // Funci贸n para determinar el estado de caducidad
        function getExpirationStatus(expirationDate) {
            if (!expirationDate) return '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const expDate = new Date(expirationDate);
            expDate.setHours(0, 0, 0, 0);
            
            const diffTime = expDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return '<span class="status-badge status-expired">CADUCADO</span>';
            }
            
            // Calcular meses y d铆as restantes
            const { meses, dias } = calculateMonthsAndDays(today, expDate);
            
            let statusText = '';
            if (meses === 0) {
                statusText = `${dias} ${dias === 1 ? 'd铆a' : 'd铆as'}`;
            } else if (dias === 0) {
                statusText = `${meses} ${meses === 1 ? 'mes' : 'meses'}`;
            } else {
                statusText = `${meses} ${meses === 1 ? 'mes' : 'meses'} y ${dias} ${dias === 1 ? 'd铆a' : 'd铆as'}`;
            }
            
            if (diffDays <= 7) {
                return `<span class="status-badge status-warning">PRXIMO (${statusText})</span>`;
            } else if (diffDays <= 30) {
                return `<span class="status-badge status-warning">EN ${statusText.toUpperCase()}</span>`;
            } else {
                return `<span class="status-badge status-ok">${statusText.toUpperCase()}</span>`;
            }
        }

        // Inventario - Renderizado
        
        function renderInventory() {
            const inventoryList = document.getElementById('inventoryList');
            const familyFilter = document.getElementById('familyFilter').value;
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();

            // Filtrar productos
            let filteredProducts = products;

            if (familyFilter) {
                filteredProducts = filteredProducts.filter(p => p.familia === familyFilter);
            }

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => 
                    (p.codes || []).some(code => String(code).toLowerCase().includes(searchTerm)) ||
                    (p.descripcion || '').toLowerCase().includes(searchTerm)
                );
            }

            // Actualizar contador
            document.getElementById('totalCount').textContent = filteredProducts.length;

            // Renderizar lista
            inventoryList.innerHTML = '';

            if (filteredProducts.length === 0) {
                inventoryList.innerHTML = '<div class="card"><p>No se encontraron productos</p></div>';
                return;
            }

            filteredProducts.forEach((product) => {
                const productEl = document.createElement('div');
                productEl.className = 'card';

                // Encontrar la fecha m谩s pr贸xima a caducar
                let closestExpiration = null;
                if (product.lotes && product.lotes.length > 0) {
                    const today = new Date();
                    const validDates = product.lotes
                        .filter(lote => lote.fecha)
                        .map(lote => new Date(lote.fecha))
                        .filter(date => !isNaN(date.getTime()));

                    if (validDates.length > 0) {
                        closestExpiration = new Date(Math.min(...validDates.map(d => d.getTime())));
                    }
                }

                const statusBadge = closestExpiration ? getExpirationStatus(closestExpiration.toISOString().split('T')[0]) : '';

                // Obtener el 铆ndice real en el array 'products' para que editar apunte al producto correcto
                const originalIndex = products.indexOf(product);

                productEl.innerHTML = `
                    <div class="product-header">
                        <div>
                            <strong>${product.descripcion || 'Sin descripci贸n'}</strong>
                            <div class="codes-display">C贸digos: ${product.codes.join(', ')}</div>
                        </div>
                        <div style="display: flex; align-items: center; margin-top: 10px;">
                            <span class="family-tag">${product.familia || 'Sin familia'}</span>
                            ${statusBadge}
                            <button class="btn" onclick="editProduct(${originalIndex})" style="margin-left: 8px;">Editar</button>
                        </div>
                    </div>
                    ${product.lotes && product.lotes.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Cajas</th>
                                    <th>Piezas</th>
                                    <th>Caducidad</th>
                                    <th>Contado</th>
                                    <th>Notas</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${product.lotes.map(lote => `
                                    <tr>
                                        <td>${lote.cajas || 0}</td>
                                        <td>${lote.piezas || 0}</td>
                                        <td>${lote.fecha || 'N/A'}</td>
                                        <td>${lote.contado || 'N/A'}</td>
                                        <td>${lote.notas || ''}</td>
                                        <td>${lote.fecha ? getExpirationStatus(lote.fecha) : ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="color: #666; font-style: italic;">No hay lotes registrados</p>'}
                `;
                inventoryList.appendChild(productEl);
            });
        }
// Editor de productos
        function populateFamilySelect() {
            const familySelect = document.getElementById('familySelect');
            const families = [...new Set(products.map(p => p.familia))].sort();
            
            familySelect.innerHTML = '<option value="">Seleccionar familia</option>';
            families.forEach(family => {
                const option = document.createElement('option');
                option.value = family;
                option.textContent = family;
                familySelect.appendChild(option);
            });
        }

        function nuevoProducto() {
            currentProductIndex = -1;
            editingCodes = [];
            editingLots = [];
            
            document.getElementById('editDesc').value = '';
            document.getElementById('familySelect').value = '';
            document.getElementById('codesList').innerHTML = '';
            document.getElementById('lotsContainer').innerHTML = '';
            
            document.getElementById('editorPanel').classList.remove('hidden');
            document.getElementById('deleteBtn').style.display = 'none';
            
            // Desplazarse al editor
            document.getElementById('editorPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function editProduct(index) {
            currentProductIndex = index;
            const product = products[index];
            
            editingCodes = [...product.codes];
            editingLots = product.lotes ? [...product.lotes] : [];
            
            document.getElementById('editDesc').value = product.descripcion || '';
            document.getElementById('familySelect').value = product.familia || '';
            
            // Render codes
            const codesList = document.getElementById('codesList');
            codesList.innerHTML = '';
            editingCodes.forEach(code => {
                const codePill = document.createElement('div');
                codePill.className = 'code-pill';
                codePill.innerHTML = `
                    ${code}
                    <span onclick="removeCode('${code.replace(/'/g, "\\'")}')"></span>
                `;
                codesList.appendChild(codePill);
            });
            
            // Render lots
            renderLots();
            
            document.getElementById('editorPanel').classList.remove('hidden');
            document.getElementById('deleteBtn').style.display = 'block';
            
            // Desplazarse al editor
            document.getElementById('editorPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function closeEditor() {
            document.getElementById('editorPanel').classList.add('hidden');
        }

        function addCode() {
            const newCodeInput = document.getElementById('newCodeInput');
            const code = newCodeInput.value.trim();
            
            if (code && !editingCodes.includes(code)) {
                editingCodes.push(code);
                
                const codesList = document.getElementById('codesList');
                const codePill = document.createElement('div');
                codePill.className = 'code-pill';
                codePill.innerHTML = `
                    ${code}
                    <span onclick="removeCode('${code.replace(/'/g, "\\'")}')"></span>
                `;
                codesList.appendChild(codePill);
                
                newCodeInput.value = '';
            }
        }

        function removeCode(code) {
            editingCodes = editingCodes.filter(c => c !== code);
            
            const codesList = document.getElementById('codesList');
            codesList.innerHTML = '';
            editingCodes.forEach(c => {
                const codePill = document.createElement('div');
                codePill.className = 'code-pill';
                codePill.innerHTML = `
                    ${c}
                    <span onclick="removeCode('${c.replace(/'/g, "\\'")}')"></span>
                `;
                codesList.appendChild(codePill);
            });
        }

        function addFamily() {
            const newFamilyInput = document.getElementById('newFamilyInput');
            const family = newFamilyInput.value.trim();
            
            if (family) {
                const familySelect = document.getElementById('familySelect');
                
                // Check if family already exists
                let exists = false;
                for (let i = 0; i < familySelect.options.length; i++) {
                    if (familySelect.options[i].value === family) {
                        exists = true;
                        break;
                    }
                }
                
                if (!exists) {
                    const option = document.createElement('option');
                    option.value = family;
                    option.textContent = family;
                    familySelect.appendChild(option);
                }
                
                familySelect.value = family;
                newFamilyInput.value = '';
            }
        }

        function addLot() {
            const cajas = document.getElementById('lot_cajas').value;
            const piezas = document.getElementById('lot_piezas').value;
            const fecha = document.getElementById('lot_fecha').value;
            const contado = document.getElementById('lot_contado').value;
            const notas = document.getElementById('lot_notas').value;
            
            if (!fecha) {
                alert('La fecha de caducidad es obligatoria');
                return;
            }
            
            editingLots.push({
                cajas: parseInt(cajas) || 0,
                piezas: parseInt(piezas) || 0,
                fecha: fecha,
                contado: contado,
                notas: notas
            });
            
            // Clear form
            document.getElementById('lot_cajas').value = '';
            document.getElementById('lot_piezas').value = '';
            document.getElementById('lot_fecha').value = '';
            document.getElementById('lot_contado').value = '';
            document.getElementById('lot_notas').value = '';
            
            renderLots();
        }

        // Funci贸n para renderizar lotes con campos editables
        function renderLots() {
            const lotsContainer = document.getElementById('lotsContainer');
            lotsContainer.innerHTML = '';
            
            if (editingLots.length === 0) {
                lotsContainer.innerHTML = '<p style="color: #666; font-style: italic;">No hay lotes agregados</p>';
                return;
            }
            
            editingLots.forEach((lot, index) => {
                const lotRow = document.createElement('div');
                lotRow.className = 'lot-row';
                
                lotRow.innerHTML = `
                    <div>
                        <label>Cajas</label>
                        <input type="number" value="${lot.cajas || 0}" onchange="updateLotField(${index}, 'cajas', this.value)">
                    </div>
                    <div>
                        <label>Piezas</label>
                        <input type="number" value="${lot.piezas || 0}" onchange="updateLotField(${index}, 'piezas', this.value)">
                    </div>
                    <div>
                        <label>Caducidad</label>
                        <input type="date" value="${lot.fecha || ''}" onchange="updateLotField(${index}, 'fecha', this.value)">
                    </div>
                    <div>
                        <label>Contado</label>
                        <input type="date" value="${lot.contado || ''}" onchange="updateLotField(${index}, 'contado', this.value)">
                    </div>
                    <div>
                        <label>Notas</label>
                        <input type="text" value="${lot.notas || ''}" onchange="updateLotField(${index}, 'notas', this.value)">
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="removeLot(${index})">Eliminar</button>
                    </div>
                `;
                lotsContainer.appendChild(lotRow);
            });
        }

        // Funci贸n: Actualizar campo de lote
        function updateLotField(index, field, value) {
            if (index >= 0 && index < editingLots.length) {
                if (field === 'cajas' || field === 'piezas') {
                    editingLots[index][field] = parseInt(value) || 0;
                } else {
                    editingLots[index][field] = value;
                }
            }
        }

        function removeLot(index) {
            editingLots.splice(index, 1);
            renderLots();
        }

        function saveProduct() {
            const descripcion = document.getElementById('editDesc').value.trim();
            const familia = document.getElementById('familySelect').value;
            
            if (!descripcion) {
                alert('La descripci贸n es obligatoria');
                return;
            }
            
            if (!familia) {
                alert('La familia es obligatoria');
                return;
            }
            
            if (editingCodes.length === 0) {
                alert('Debe agregar al menos un c贸digo');
                return;
            }
            
            const productData = {
                codes: editingCodes,
                descripcion: descripcion,
                familia: familia,
                lotes: editingLots
            };
            
            if (currentProductIndex === -1) {
                // Nuevo producto
                products.push(productData);
            } else {
                // Editar producto existente
                products[currentProductIndex] = productData;
            }
            
            // Guardar en localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            closeEditor();
            renderInventory();
            populateFamilyFilter();
            populateFamilySelect();
            renderDashboard();
            
            // Mostrar notificaci贸n para guardar en Excel
            showSaveNotification('Control_Caducidades.xlsx');
        }

        function deleteProduct() {
            if (currentProductIndex === -1) return;
            
            if (confirm('驴Est谩 seguro de eliminar este producto?')) {
                products.splice(currentProductIndex, 1);
                
                // Guardar en localStorage
                localStorage.setItem('products', JSON.stringify(products));
                
                closeEditor();
                renderInventory();
                populateFamilyFilter();
                populateFamilySelect();
                renderDashboard();
                
                // Mostrar notificaci贸n para guardar en Excel
                showSaveNotification('Control_Caducidades.xlsx');
            }
        }

        // Reportes - Renderizado de opciones
        function renderReports() {
            const rangesContainer = document.getElementById('rangesContainer');
            rangesContainer.innerHTML = '';
            
            const ranges = [
                { id: '7days', label: 'Pr贸ximos 1-7 d铆as' },
                { id: '15days', label: 'Pr贸ximos 15 d铆as' },
                { id: '1month', label: '1 mes' },
                { id: '2months', label: '2 meses' },
                { id: '3months', label: '3 meses' },
                { id: '4months', label: '4 meses' },
                { id: '5months', label: '5 meses' },
                { id: '6months', label: '6 meses' },
                { id: '7to9months', label: '7 a 9 meses' },
                { id: '1year', label: '1 a帽o en adelante' },
                { id: 'expired', label: 'Caducados' }
            ];
            
            ranges.forEach(range => {
                const rangeItem = document.createElement('div');
                rangeItem.className = 'range-item';
                rangeItem.innerHTML = `
                    <input type="checkbox" id="${range.id}" onchange="generateReport()">
                    <label for="${range.id}">${range.label}</label>
                `;
                rangesContainer.appendChild(rangeItem);
            });
        }

        function selectAllRanges() {
            document.querySelectorAll('#rangesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            generateReport();
        }

        function clearRanges() {
            document.querySelectorAll('#rangesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            generateReport();
        }

        // Reportes - Generaci贸n
        function generateReport() {
            const reportResult = document.getElementById('reportResult');
            const selectedRanges = [];
            
            // Obtener rangos seleccionados
            document.querySelectorAll('#rangesContainer input[type="checkbox"]:checked').forEach(checkbox => {
                selectedRanges.push(checkbox.id);
            });
            
            if (selectedRanges.length === 0) {
                reportResult.innerHTML = '<div class="card"><p>Seleccione al menos un rango para generar el reporte</p></div>';
                return;
            }
            
            // Calcular fechas de referencia
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalizar a inicio del d铆a
            
            const sevenDays = new Date(today);
            sevenDays.setDate(today.getDate() + 7);
            
            const fifteenDays = new Date(today);
            fifteenDays.setDate(today.getDate() + 15);
            
            const oneMonth = new Date(today);
            oneMonth.setMonth(today.getMonth() + 1);
            
            const twoMonths = new Date(today);
            twoMonths.setMonth(today.getMonth() + 2);
            
            const threeMonths = new Date(today);
            threeMonths.setMonth(today.getMonth() + 3);
            
            const fourMonths = new Date(today);
            fourMonths.setMonth(today.getMonth() + 4);
            
            const fiveMonths = new Date(today);
            fiveMonths.setMonth(today.getMonth() + 5);
            
            const sixMonths = new Date(today);
            sixMonths.setMonth(today.getMonth() + 6);
            
            const nineMonths = new Date(today);
            nineMonths.setMonth(today.getMonth() + 9);
            
            const oneYear = new Date(today);
            oneYear.setFullYear(today.getFullYear() + 1);
            
            // Filtrar productos seg煤n los rangos seleccionados
            let filteredProducts = [];
            
            products.forEach(product => {
                if (product.lotes && product.lotes.length > 0) {
                    product.lotes.forEach(lote => {
                        if (lote.fecha) {
                            const expirationDate = new Date(lote.fecha);
                            expirationDate.setHours(0, 0, 0, 0);
                            
                            let includeInReport = false;

                            // Verificar si el lote cumple con alguno de los rangos seleccionados
                            if (selectedRanges.includes('expired') && expirationDate < today) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('7days') && expirationDate >= today && expirationDate <= sevenDays) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('15days') && expirationDate > sevenDays && expirationDate <= fifteenDays) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('1month') && expirationDate > fifteenDays && expirationDate <= oneMonth) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('2months') && expirationDate > oneMonth && expirationDate <= twoMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('3months') && expirationDate > twoMonths && expirationDate <= threeMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('4months') && expirationDate > threeMonths && expirationDate <= fourMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('5months') && expirationDate > fourMonths && expirationDate <= fiveMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('6months') && expirationDate > fiveMonths && expirationDate <= sixMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('7to9months') && expirationDate > sixMonths && expirationDate <= nineMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('1year') && expirationDate > nineMonths) {
                                includeInReport = true;
                            }
                            
                            if (includeInReport) {
                                // Clonar el producto para no modificar el original
                                const productCopy = {...product};
                                productCopy.loteEspecifico = {...lote};
                                filteredProducts.push(productCopy);
                            }
                        }
                    });
                }
            });
            
            // Mostrar resultados
            if (filteredProducts.length === 0) {
                reportResult.innerHTML = '<div class="card"><p>No se encontraron productos en los rangos seleccionados</p></div>';
                return;
            }
            
            let reportHTML = `
                <div class="card">
                    <h3>Resultados del Reporte (${filteredProducts.length} productos)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>C贸digo</th>
                                <th>Descripci贸n</th>
                                <th>Familia</th>
                                <th>Cajas</th>
                                <th>Piezas</th>
                                <th>Caducidad</th>
                                <th>Contado</th>
                                <th>Notas</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredProducts.forEach(product => {
                // MODIFICACIN: Mostrar solo el primer c贸digo en lugar de todos
                const primerCodigo = product.codes.length > 0 ? product.codes[0] : '';
                
                reportHTML += `
                    <tr>
                        <td>${primerCodigo}</td>  <!-- Cambiado aqu铆 -->
                        <td>${product.descripcion}</td>
                        <td>${product.familia}</td>
                        <td>${product.loteEspecifico.cajas || 0}</td>
                        <td>${product.loteEspecifico.piezas || 0}</td>
                        <td>${product.loteEspecifico.fecha || 'N/A'}</td>
                        <td>${product.loteEspecifico.contado || 'N/A'}</td>
                        <td>${product.loteEspecifico.notas || ''}</td>
                        <td>${product.loteEspecifico.fecha ? getExpirationStatus(product.loteEspecifico.fecha) : ''}</td>
                    </tr>
                `;
            });
            
            reportHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            reportResult.innerHTML = reportHTML;
        }

        function exportReportToExcel() {
            // Primero generar el reporte actual
            generateReport();
            
            // Obtener los datos de la tabla de reportes
            const reportTable = document.querySelector('#reportResult table');
            if (!reportTable) {
                alert('No hay datos para exportar');
                return;
            }
            
            // Convertir la tabla a un libro de Excel
            const wb = XLSX.utils.table_to_book(reportTable);
            
            // Guardar el archivo
            XLSX.writeFile(wb, 'Reporte_Caducidades.xlsx');
        }

        // Importar desde Excel
        function importExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            const format = document.querySelector('input[name="importFormat"]:checked').value;
            
            if (!file) {
                alert('Por favor, seleccione un archivo Excel');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Obtener la primera hoja
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                let jsonData;
                if (format === 'basic') {
                    // Formato b谩sico: C贸digo, Descripci贸n, Familia
                    jsonData = XLSX.utils.sheet_to_json(worksheet, { header: ['codigo', 'descripcion', 'familia'] });
                    
                    // Eliminar la primera fila si son encabezados
                    if (jsonData.length > 0 && jsonData[0].codigo === 'C贸digo') {
                        jsonData.shift();
                    }
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    
                    // Procesar cada fila
                    jsonData.forEach(row => {
                        if (row.codigo && row.descripcion && row.familia) {
                            const code = String(row.codigo).trim();
                            const descripcion = String(row.descripcion).trim();
                            const familia = String(row.familia).trim();
                            
                            // Verificar si el producto ya existe por c贸digo
                            const existingIndex = products.findIndex(p => p.codes.includes(code));
                            
                            if (existingIndex !== -1) {
                                // Actualizar producto existente
                                products[existingIndex].descripcion = descripcion;
                                products[existingIndex].familia = familia;
                                updatedCount++;
                            } else {
                                // Crear nuevo producto
                                products.push({
                                    codes: [code],
                                    descripcion: descripcion,
                                    familia: familia,
                                    lotes: []
                                });
                                importedCount++;
                            }
                        }
                    });
                    
                    // Mostrar resultados
                    const importResult = document.getElementById('importResult');
                    importResult.innerHTML = `
                        <div class="import-summary">
                            <h4>Importaci贸n completada (Formato b谩sico)</h4>
                            <p>Productos nuevos: ${importedCount}</p>
                            <p>Productos actualizados: ${updatedCount}</p>
                            <p>Total de productos en sistema: ${products.length}</p>
                        </div>
                    `;
                } else {
                    // Formato completo: C贸digo, Descripci贸n, Familia, Cajas, Piezas, Fecha Caducidad, Fecha Contado, Notas
                    jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: ['codigo', 'descripcion', 'familia', 'cajas', 'piezas', 'fechaCaducidad', 'fechaContado', 'notas'] 
                    });
                    
                    // Eliminar la primera fila si son encabezados
                    if (jsonData.length > 0 && jsonData[0].codigo === 'C贸digo') {
                        jsonData.shift();
                    }
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    let lotesCount = 0;
                    
                    // Procesar cada fila
                    jsonData.forEach(row => {
                        if (row.codigo && row.descripcion && row.familia) {
                            const code = String(row.codigo).trim();
                            const descripcion = String(row.descripcion).trim();
                            const familia = String(row.familia).trim();
                            
                            // Verificar si el producto ya existe por c贸digo
                            const existingIndex = products.findIndex(p => p.codes.includes(code));
                            
                            // Preparar datos del lote
                            const lote = {
                                cajas: parseInt(row.cajas) || 0,
                                piezas: parseInt(row.piezas) || 0,
                                fecha: row.fechaCaducidad || '',
                                contado: row.fechaContado || '',
                                notas: row.notas || ''
                            };
                            
                            if (existingIndex !== -1) {
                                // Actualizar producto existente
                                products[existingIndex].descripcion = descripcion;
                                products[existingIndex].familia = familia;
                                
                                // Agregar lote si tiene fecha de caducidad
                                if (lote.fecha) {
                                    if (!products[existingIndex].lotes) {
                                        products[existingIndex].lotes = [];
                                    }
                                    products[existingIndex].lotes.push(lote);
                                    lotesCount++;
                                }
                                
                                updatedCount++;
                            } else {
                                // Crear nuevo producto
                                const newProduct = {
                                    codes: [code],
                                    descripcion: descripcion,
                                    familia: familia,
                                    lotes: []
                                };
                                
                                // Agregar lote si tiene fecha de caducidad
                                if (lote.fecha) {
                                    newProduct.lotes.push(lote);
                                    lotesCount++;
                                }
                                
                                products.push(newProduct);
                                importedCount++;
                            }
                        }
                    });
                    
                    // Mostrar resultados
                    const importResult = document.getElementById('importResult');
                    importResult.innerHTML = `
                        <div class="import-summary">
                            <h4>Importaci贸n completada (Formato completo)</h4>
                            <p>Productos nuevos: ${importedCount}</p>
                            <p>Productos actualizados: ${updatedCount}</p>
                            <p>Lotes importados: ${lotesCount}</p>
                            <p>Total de productos en sistema: ${products.length}</p>
                        </div>
                    `;
                }
                
                // Guardar en localStorage
                localStorage.setItem('products', JSON.stringify(products));
                
                // Actualizar la interfaz
                populateFamilyFilter();
                populateFamilySelect();
                renderInventory();
                renderDashboard();
                
                // Mostrar notificaci贸n para guardar en Excel
                showSaveNotification('Control_Caducidades.xlsx');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function clearAllProducts() {
            if (confirm('驴Est谩 seguro de eliminar TODOS los productos? Esta acci贸n no se puede deshacer.')) {
                products = [];
                localStorage.setItem('products', JSON.stringify(products));
                
                // Actualizar la interfaz
                populateFamilyFilter();
                populateFamilySelect();
                renderInventory();
                renderDashboard();
                
                // Mostrar notificaci贸n para guardar en Excel
                showSaveNotification('Control_Caducidades.xlsx');
            }
        }

        
        // Funci贸n para comprobar el uso de almacenamiento local
        function checkStorageUsage() {
            let usedBytes = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    usedBytes += ((localStorage[key].length + key.length) * 2);
                }
            }
            const usedKB = (usedBytes / 1024).toFixed(2);
            const usedMB = (usedBytes / (1024*1024)).toFixed(2);
            const limitMB = 5; // l铆mite estimado para la mayor铆a de navegadores
            const percent = ((usedMB / limitMB) * 100).toFixed(1);
            
            document.getElementById('storageUsageResult').innerText =
                `Uso actual: ${usedKB} KB (${usedMB} MB) / ${limitMB} MB (~${percent}% del l铆mite)`;
        }

        // Funci贸n para mostrar el modal de opciones de guardado
        function showSaveOptions() {
            document.getElementById('saveModal').style.display = 'flex';
        }
        
        // Funci贸n para cerrar el modal de opciones de guardado
        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }
        
        // Funci贸n modificada para guardar en Excel con opciones
        function saveToExcel(mode) {
            closeSaveModal();
            
            // Preparar datos para exportar
            const dataToExport = [];
            
            // Encabezados
            dataToExport.push(['C贸digo', 'Descripci贸n', 'Familia', 'Cajas', 'Piezas', 'Fecha Caducidad', 'Fecha Contado', 'Notas']);
            
            // Datos de productos
            products.forEach(product => {
                if (product.lotes && product.lotes.length > 0) {
                    product.lotes.forEach(lote => {
                        dataToExport.push([
                            product.codes.join(', '),
                            product.descripcion,
                            product.familia,
                            lote.cajas || 0,
                            lote.piezas || 0,
                            lote.fecha || '',
                            lote.contado || '',
                            lote.notas || ''
                        ]);
                    });
                } else {
                    dataToExport.push([
                        product.codes.join(', '),
                        product.descripcion,
                        product.familia,
                        '',
                        '',
                        '',
                        '',
                        ''
                    ]);
                }
            });
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            
            // A帽adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Productos');
            
            // Determinar el nombre del archivo seg煤n el modo
            let fileName = 'Control_Caducidades.xlsx';
            if (mode === 'new') {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                fileName = `Control_Caducidades_${timestamp}.xlsx`;
            }
            
            // Guardar archivo
            XLSX.writeFile(wb, fileName);
            
            // Mostrar notificaci贸n
            showSaveNotification(fileName);
        }
        
        // Funci贸n para mostrar notificaci贸n de guardado
        function showSaveNotification(fileName) {
            const notification = document.getElementById('saveNotification');
            notification.textContent = `Datos guardados exitosamente en ${fileName}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>